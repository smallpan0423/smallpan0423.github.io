<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>小潘的筆記</title>
  <style>
    body { margin:0; background-color:#DCB5FF; font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif; }
    .center { text-align:center; margin: 1.5rem 0; }
    .downloads { max-width: 900px; margin: 0 auto; padding: 0 1rem; list-style: none; }
    .downloads li { margin: .6rem 0; }
    .updated { color:#444; opacity:.85; margin-left:.5rem; font-size:.95rem; }
    .filters.center { margin-top: .5rem; }
    .tag { display:inline-block; margin:.25rem; padding:.4rem .8rem; border-radius:999px; border:1px solid rgba(0,0,0,.15); background:#fff; cursor:pointer; }
    .tag.active { background:#6c5ce7; color:#fff; border-color:#6c5ce7; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <h2 class="center">嗨我是小潘，歡迎來到我的個人網站，這裡可以找到關於我的物理學筆記、鋼琴樂譜、參考書</h2>

  <!-- 分類按鈕 -->
  <nav class="filters center" aria-label="檔案分類">
    <button type="button" class="tag active" data-cat="all">全部</button>
    <button type="button" class="tag" data-cat="em">四大力學筆記</button>
    <button type="button" class="tag" data-cat="math">數學筆記</button>
    <button type="button" class="tag" data-cat="thesis">畢業論文</button>
    <button type="button" class="tag" data-cat="music">樂譜</button>
    <button type="button" class="tag" data-cat="other">其他</button>
  </nav>

  <!-- 檔案清單（交給 JS 產生） -->
  <ul class="downloads" id="fileList"></ul>

  <!-- 直接連到 GitHub 上傳資料夾 -->
  <p class="center">
    <a href="https://github.com/smallpan0423/smallpan0423.github.io/upload/main/downloads" target="_blank" rel="noopener">
      上傳新檔到 downloads/
    </a>
  </p>

  <script>
    // ===== 設定：downloads.json 的位置（docs/ 發佈就改成 'docs/downloads.json'） =====
     const MANIFEST_URL = 'downloads.json?v=' + Date.now();
// 若 Pages 來源是 docs/ 也 OK，因為我們兩邊都寫了;

    // ===== 分類功能（只保留這一份） =====
    const buttons = document.querySelectorAll('.filters .tag');
    const listEl  = document.getElementById('fileList');

    function applyFilter(cat) {
      [...listEl.children].forEach(li => {
        li.classList.toggle('hidden', !(cat === 'all' || li.dataset.folder === cat));
      });
      buttons.forEach(b => b.classList.toggle('active', b.dataset.cat === cat));
      if (cat === 'all') history.replaceState(null,'',location.pathname);
      else location.hash = `cat=${cat}`;
    }
    buttons.forEach(btn => btn.addEventListener('click', () => applyFilter(btn.dataset.cat)));

    // ===== 手機/內建瀏覽器 PDF 預覽加強：渲染後套用 =====
    function enhancePdfLinks(container){
      const ua = navigator.userAgent;
      const inApp = /FBAN|FBAV|Instagram|Line\//i.test(ua);
      const iOS   = /iPhone|iPad|iPod/i.test(ua);
      const BIG_MB = 50;
      const toGView = abs => 'https://docs.google.com/viewer?embedded=1&url=' + encodeURIComponent(abs);

      (async () => {
        const links = [...container.querySelectorAll('a[target="_blank"]')].filter(a => /\.pdf(\?|$)/i.test(a.href));
        for (const a of links) {
          const abs = new URL(a.getAttribute('href'), location.origin).href;
          if (inApp) { a.href = toGView(abs); continue; }
          if (iOS) {
            try {
              const r = await fetch(a.getAttribute('href'), { method:'HEAD', cache:'no-store' });
              const len = +(r.headers.get('content-length') || 0);
              if (len && len > BIG_MB * 1024 * 1024) a.href = toGView(abs);
            } catch {}
          }
        }
      })();
    }

    // ===== 載入 downloads.json 並渲染清單 =====
    (async () => {
      const fmt = new Intl.DateTimeFormat('zh-TW', { dateStyle:'medium', timeStyle:'short', hour12:false, timeZone:'Asia/Taipei' });
      try {
        const res = await fetch(MANIFEST_URL, { cache:'no-store' });
        const items = await res.json(); // [{path,name,folder,size,updated,url}]
        const frag = document.createDocumentFragment();

        for (const it of items) {
          const li = document.createElement('li');
          li.dataset.folder = it.folder || 'misc';

          // 預覽（新分頁）
          const a = document.createElement('a');
          a.href = it.path; a.target = '_blank'; a.rel = 'noopener';
          a.textContent = it.name;      // 需要顯示中文標題可在 Actions 端加 mapping
          li.appendChild(a);

          // 更新時間
          const span = document.createElement('span');
          span.className = 'updated';
          span.textContent = `（更新：${fmt.format(new Date(it.updated))}）`;
          li.appendChild(span);

          // 檔案大小（MB）
          const sz = document.createElement('span');
          sz.textContent = ` · ${(it.size/1024/1024).toFixed(2)} MB`;
          li.appendChild(sz);

          // 下載按鈕（可選）
          const dl = document.createElement('a');
          dl.href = it.path; dl.download = it.name; dl.style.marginLeft = '.5rem';
          dl.textContent = '下載';
          li.appendChild(dl);

          frag.appendChild(li);
        }

        listEl.innerHTML = '';
        listEl.appendChild(frag);

        // 套用分類（支援 #cat=thesis）
        const m = location.hash.match(/cat=([a-z0-9_-]+)/i);
        applyFilter(m ? m[1] : 'all');

        // 最後：讓 PDF 連結具備行動裝置預覽相容性
        enhancePdfLinks(listEl);
      } catch (e) {
        listEl.innerHTML = '<li>清單載入失敗，請稍後重試。</li>';
        console.error('載入 downloads.json 失敗：', e);
      }
    })();
  </script>
 

</body>
</html>
